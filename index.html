<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Owl Math Master: Ultimate Edition</title>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f0f9ff; 
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            touch-action: manipulation; /* Prevents double-tap zoom on mobile */
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Responsive Input Styling */
        .digit-input {
            width: 100%;
            height: 100%;
            aspect-ratio: 1/1; /* Square inputs look better on mobile */
            font-size: clamp(1.2rem, 4vw, 1.8rem); /* Responsive font size */
            text-align: center;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            background: white;
            transition: all 0.2s;
            color: #333;
            font-weight: bold;
            padding: 0;
            margin: 0;
        }
        
        .digit-input:focus {
            border-color: #3b82f6;
            outline: none;
            transform: scale(1.05);
            background-color: #eff6ff;
            z-index: 50;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .digit-input.correct {
            background-color: #dcfce7;
            border-color: #22c55e;
            color: #15803d;
        }
        
        .digit-input.wrong {
            background-color: #fee2e2;
            border-color: #ef4444;
            animation: shake 0.4s;
        }
        
        .owl-blocker {
            transition: all 0.5s ease-in-out;
            animation: float 3s ease-in-out infinite;
        }

        /* Prevent scrollbars from looking ugly on mobile */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .bounce-zero {
            animation: bounce 1s infinite;
            border-color: #eab308;
            border-width: 3px;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(-10%); }
            50% { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- PROBLEM GENERATION LOGIC ---
        const generateProblem = (level) => {
            const rand = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            let top, bot;

            switch(level) {
                case 1: // Easy: 1-4 digit x 1 digit
                    const l1Type = rand(1, 4);
                    const l1Max = Math.pow(10, l1Type) - 1;
                    const l1Min = Math.pow(10, l1Type - 1);
                    top = rand(l1Min, l1Max); 
                    bot = rand(2, 9);
                    break;
                case 2: // Medium: 5-8 digit x 1 digit
                    const l2Type = rand(5, 8);
                    const l2Max = Math.pow(10, l2Type) - 1;
                    const l2Min = Math.pow(10, l2Type - 1);
                    top = rand(l2Min, l2Max);
                    bot = rand(2, 9);
                    break;
                case 3: // Moderate: 2-4 digit x 2 digit
                    const l3Type = rand(2, 4);
                    const l3Max = Math.pow(10, l3Type) - 1;
                    const l3Min = Math.pow(10, l3Type - 1);
                    top = rand(l3Min, l3Max);
                    bot = rand(11, 99);
                    break;
                case 4: // Hard: 5-7 digit x 2 digit
                    const l4Type = rand(5, 7);
                    const l4Max = Math.pow(10, l4Type) - 1;
                    const l4Min = Math.pow(10, l4Type - 1);
                    top = rand(l4Min, l4Max);
                    bot = rand(11, 99);
                    break;
                default:
                    top = 12; bot = 3;
            }
            return { top, bot, level };
        };

        // --- AUDIO HELPERS ---
        const playTone = (freq, type = 'sine', dur=0.1) => {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.type = type;
            osc.frequency.value = freq;
            osc.connect(gain);
            gain.connect(ctx.destination);
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + dur);
            osc.stop(ctx.currentTime + dur);
        };
        const playSuccess = () => { playTone(440); setTimeout(()=>playTone(554),100); setTimeout(()=>playTone(659),200); };
        const playError = () => playTone(150, 'sawtooth', 0.3);

        // --- INPUT COMPONENT ---
        const InputCell = ({ val, onChange, idx, correctVal, disabled, isZeroCheck, prefix }) => {
            const isCorrect = val === correctVal && val !== '';
            const isWrong = val !== '' && val !== correctVal && !disabled;

            const handleChange = (e) => {
                const v = e.target.value;
                if (!/^\d*$/.test(v)) return;
                onChange(v, idx);
                
                // Auto-shift left logic
                if (v.length === 1 && idx > 0) {
                    const prev = document.getElementById(`${prefix}-${idx-1}`);
                    if (prev && !prev.disabled) { prev.focus(); prev.select(); }
                }
            };

            return (
                <input
                    id={`${prefix}-${idx}`}
                    inputMode="numeric"
                    maxLength="1"
                    className={`digit-input ${isCorrect?'correct':''} ${isWrong?'wrong':''} ${isZeroCheck?'bounce-zero':''}`}
                    value={val}
                    onChange={handleChange}
                    disabled={disabled}
                    placeholder={isZeroCheck ? "0" : ""}
                    autoComplete="off"
                />
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('menu');
            const [level, setLevel] = useState(1);
            const [problemNum, setProblemNum] = useState(1);
            const [score, setScore] = useState(0);
            
            // Math State
            const [topNum, setTopNum] = useState(0);
            const [botNum, setBotNum] = useState(0);
            
            // Grid State
            const [gridCols, setGridCols] = useState(6);
            
            const [row1, setRow1] = useState([]);
            const [row2, setRow2] = useState([]);
            const [final, setFinal] = useState([]);
            const [carry, setCarry] = useState('');
            
            const [step, setStep] = useState(0);
            const [message, setMessage] = useState({ text: "", type: "neutral" });

            // --- COMPUTED VALUES ---
            const botOnes = botNum % 10;
            const botTens = Math.floor(botNum / 10);
            const isTwoDigitBot = botNum >= 10;
            
            const prod1 = topNum * botOnes;
            const prod2 = topNum * botTens;
            const finalAns = topNum * botNum;

            const getAlignedDigits = (num, totalCols) => {
                const str = num.toString();
                const arr = Array(totalCols).fill('');
                for (let i=0; i < str.length; i++) {
                    arr[totalCols - 1 - i] = str[str.length - 1 - i];
                }
                return arr;
            };

            const p1Digits = getAlignedDigits(prod1, gridCols);
            const p2Digits = getAlignedDigits(prod2 * 10, gridCols); 
            const fDigits = getAlignedDigits(finalAns, gridCols);

            const topDigits = getAlignedDigits(topNum, gridCols);
            const botDigits = getAlignedDigits(botNum, gridCols);

            // --- GAME LOGIC ---

            const startGame = (lvl) => {
                setLevel(lvl);
                setProblemNum(1);
                setScore(0);
                loadProblem(lvl);
                setGameState('playing');
            };

            const loadProblem = (lvl) => {
                const p = generateProblem(lvl);
                
                // Calculate required columns EXACTLY based on result length
                const maxLen = (p.top * p.bot).toString().length;
                // Min 3 columns to look decent for small numbers like 12*2=24
                const newCols = Math.max(3, maxLen); 

                setGridCols(newCols);
                setTopNum(p.top);
                setBotNum(p.bot);
                
                setRow1(Array(newCols).fill(''));
                setRow2(Array(newCols).fill(''));
                setFinal(Array(newCols).fill(''));
                setCarry('');
                
                setStep(1); 
                setMessage({ text: `Q${problemNum}/10: Multiply ${p.top} √ó ${p.bot % 10}`, type: "neutral" });
            };

            const handleNext = () => {
                if (problemNum >= 10) {
                    setGameState('summary');
                } else {
                    setProblemNum(p => p + 1);
                    setTimeout(() => loadProblem(level), 0);
                }
            };

            const checkRow1 = () => {
                const userVal = parseInt(row1.join('')) || 0;
                if (userVal === prod1) {
                    playSuccess();
                    if (isTwoDigitBot) {
                        setStep(2);
                        setMessage({ text: "Correct! Place the Zero!", type: "neutral" });
                    } else {
                        setStep(5);
                        setScore(s => s + 1);
                        setMessage({ text: "Excellent!", type: "success" });
                    }
                } else {
                    playError();
                    setMessage({ text: `Check: ${topNum} √ó ${botOnes}`, type: "error" });
                }
            };

            const checkZero = () => {
                if (row2[gridCols - 1] === '0') {
                    playSuccess();
                    setStep(3);
                    setMessage({ text: `Now multiply ${topNum} √ó ${botTens}`, type: "neutral" });
                    setTimeout(() => {
                        const el = document.getElementById(`r2-${gridCols-2}`);
                        if(el) el.focus();
                    }, 50);
                } else {
                    playError();
                    setMessage({ text: "Place the Zero in the Ones place!", type: "error" });
                }
            };

            const checkRow2 = () => {
                const userVal = parseInt(row2.join('')) || 0;
                if (userVal === prod2 * 10) { 
                    playSuccess();
                    setStep(4);
                    setMessage({ text: "Perfect! Add them up.", type: "neutral" });
                } else {
                    playError();
                    setMessage({ text: `Check: ${topNum} √ó ${botTens}`, type: "error" });
                }
            };

            const checkFinal = () => {
                const userVal = parseInt(final.join('')) || 0;
                if (userVal === finalAns) {
                    playSuccess();
                    setStep(5);
                    setScore(s => s + 1);
                    setMessage({ text: "üéâ AMAZING!", type: "success" });
                } else {
                    playError();
                    setMessage({ text: "Check your addition!", type: "error" });
                }
            };

            const updateArr = (val, idx, arr, setArr) => {
                const newArr = [...arr];
                newArr[idx] = val;
                setArr(newArr);
            };

            const renderOwlInGrid = (rowIndex, colIndex) => {
                if (gameState !== 'playing' || step === 5) return null;
                if (!isTwoDigitBot) return null;

                const isBotOnesCell = colIndex === gridCols - 1;
                const isBotTensCell = colIndex === gridCols - 2;

                if (step === 1 && isBotTensCell) {
                    return <div className="absolute inset-0 flex items-center justify-center bg-blue-500 text-white rounded owl-blocker text-xs z-10 pointer-events-none">ü¶â</div>;
                }
                if (step >= 3 && isBotOnesCell) {
                    return <div className="absolute inset-0 flex items-center justify-center bg-blue-500 text-white rounded owl-blocker text-xs z-10 pointer-events-none">ü¶â</div>;
                }
                return null;
            };

            if (gameState === 'menu') {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 max-w-md mx-auto">
                        <h1 className="text-4xl font-bold text-blue-600 mb-2 text-center">ü¶â Owl Math Master</h1>
                        <p className="text-gray-500 mb-8 font-semibold">Ultimate Edition</p>
                        
                        <div className="grid gap-4 w-full">
                            <button onClick={()=>startGame(1)} className="bg-green-100 hover:bg-green-200 border-2 border-green-500 p-4 rounded-xl text-left shadow-sm active:scale-95 transition-transform">
                                <div className="font-bold text-green-700 text-xl">üü¢ Level 1: Foundation</div>
                                <div className="text-sm text-green-600">Up to 4-digit √ó 1-digit</div>
                            </button>
                            <button onClick={()=>startGame(2)} className="bg-yellow-100 hover:bg-yellow-200 border-2 border-yellow-500 p-4 rounded-xl text-left shadow-sm active:scale-95 transition-transform">
                                <div className="font-bold text-yellow-700 text-xl">üü° Level 2: Big Numbers</div>
                                <div className="text-sm text-yellow-600">Up to 8-digit √ó 1-digit</div>
                            </button>
                            <button onClick={()=>startGame(3)} className="bg-blue-100 hover:bg-blue-200 border-2 border-blue-500 p-4 rounded-xl text-left shadow-sm active:scale-95 transition-transform">
                                <div className="font-bold text-blue-700 text-xl">üîµ Level 3: Dual Digits</div>
                                <div className="text-sm text-blue-600">Up to 4-digit √ó 2-digit</div>
                            </button>
                            <button onClick={()=>startGame(4)} className="bg-red-100 hover:bg-red-200 border-2 border-red-500 p-4 rounded-xl text-left shadow-sm active:scale-95 transition-transform">
                                <div className="font-bold text-red-700 text-xl">üî¥ Level 4: Expert</div>
                                <div className="text-sm text-red-600">Up to 7-digit √ó 2-digit</div>
                            </button>
                        </div>
                    </div>
                );
            }

            if (gameState === 'summary') {
                 return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 max-w-md mx-auto text-center">
                        <h1 className="text-4xl font-bold mb-4">üéâ Level Complete!</h1>
                        <div className="text-6xl mb-6">{score >= 8 ? 'üåü' : 'üëç'}</div>
                        <p className="text-2xl font-bold text-gray-700 mb-2">Score: {score} / 10</p>
                        <button onClick={()=>setGameState('menu')} className="bg-blue-600 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-transform">
                            Back to Menu
                        </button>
                    </div>
                 );
            }

            return (
                <div className="min-h-screen flex flex-col items-center max-w-4xl mx-auto bg-gray-50 sm:bg-transparent">
                    {/* Header */}
                    <div className="w-full flex justify-between items-center p-3 bg-white shadow-sm sm:rounded-b-xl sticky top-0 z-20">
                        <button onClick={()=>setGameState('menu')} className="text-gray-400 font-bold text-sm px-2">‚úï QUIT</button>
                        <div className="flex flex-col items-center">
                            <span className="text-xs font-bold text-gray-400">LEVEL {level}</span>
                            <div className="flex gap-1 mt-1">
                                {[...Array(10)].map((_, i) => (
                                    <div key={i} className={`h-1.5 w-1.5 sm:h-2 sm:w-2 rounded-full ${i < problemNum ? (i < score + (problemNum-score) ? 'bg-blue-500' : 'bg-red-300') : 'bg-gray-200'}`}></div>
                                ))}
                            </div>
                        </div>
                        <div className="font-mono font-bold text-blue-600 px-2">{score}/{problemNum-1}</div>
                    </div>

                    {/* Message Bar */}
                    <div className={`w-full max-w-md text-center p-2 text-sm sm:text-base mb-2 sm:mb-4 sm:rounded-lg font-bold transition-colors ${
                        message.type === 'error' ? 'bg-red-100 text-red-700' :
                        message.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-blue-50 text-blue-700'
                    }`}>
                        {message.text}
                    </div>

                    {/* Main Grid Area - Scrollable Container */}
                    <div className="flex-1 w-full flex flex-col items-center justify-center p-2 sm:p-4 overflow-hidden">
                        <div className="bg-white p-3 sm:p-6 rounded-2xl shadow-lg w-full max-w-full overflow-x-auto no-scrollbar">
                            <div className="min-w-min mx-auto">
                                
                                {/* Grid Container */}
                                <div className="grid gap-1 sm:gap-2" 
                                     style={{ 
                                         // Dynamic Grid Sizing: 
                                         // Mobile: min 28px per cell. Desktop: min 40px.
                                         gridTemplateColumns: `repeat(${gridCols}, minmax(32px, 50px))` 
                                     }}>
                                    
                                    {/* Carry Row */}
                                    <div className="col-span-full h-6 sm:h-8 flex justify-end pr-2 relative mb-1">
                                        {step > 0 && step < 5 && (
                                            <div className="text-red-400 font-bold text-xs sm:text-sm flex gap-1 items-center">
                                                <span>carry:</span>
                                                <input 
                                                    value={carry} onChange={e=>setCarry(e.target.value)} 
                                                    className="w-12 border-b border-red-300 text-center outline-none bg-transparent" 
                                                    inputMode="numeric"
                                                />
                                            </div>
                                        )}
                                    </div>

                                    {/* Top Number */}
                                    {topDigits.map((d, i) => (
                                        <div key={`top-${i}`} className="font-mono text-2xl sm:text-3xl font-bold text-gray-700 flex items-center justify-center h-10 sm:h-12">
                                            {d}
                                        </div>
                                    ))}

                                    {/* Bottom Number */}
                                    {botDigits.map((d, i) => (
                                        <div key={`bot-${i}`} className="relative font-mono text-2xl sm:text-3xl font-bold text-gray-800 flex items-center justify-center h-10 sm:h-12 border-b-2 sm:border-b-4 border-gray-800">
                                            {i === 0 && <span className="absolute left-[-15px] sm:left-[-20px] text-gray-400 text-lg">√ó</span>}
                                            {d}
                                            {renderOwlInGrid(1, i)}
                                        </div>
                                    ))}

                                    {/* Row 1 Inputs */}
                                    {row1.map((val, i) => (
                                        <div key={`r1-${i}`} className="flex justify-center items-center">
                                            <InputCell 
                                                val={val} idx={i} prefix="r1"
                                                onChange={(v, idx)=>updateArr(v, idx, row1, setRow1)}
                                                correctVal={p1Digits[i]}
                                                disabled={step !== 1}
                                            />
                                        </div>
                                    ))}

                                    {/* Row 2 Inputs */}
                                    {isTwoDigitBot && (
                                        <>
                                            <div className="col-span-full text-left text-gray-400 text-lg font-bold pl-1">+</div>
                                            {row2.map((val, i) => (
                                                <div key={`r2-${i}`} className="flex justify-center items-center">
                                                    <InputCell 
                                                        val={val} idx={i} prefix="r2"
                                                        onChange={(v, idx)=>updateArr(v, idx, row2, setRow2)}
                                                        correctVal={p2Digits[i]}
                                                        disabled={step < 2 || step > 3 || (step === 2 && i !== gridCols - 1)}
                                                        isZeroCheck={step === 2 && i === gridCols - 1}
                                                    />
                                                </div>
                                            ))}
                                        </>
                                    )}

                                    {/* Final Inputs */}
                                    {isTwoDigitBot && (
                                        <>
                                            <div className="col-span-full border-b-2 sm:border-b-4 border-gray-800 my-1"></div>
                                            {final.map((val, i) => (
                                                <div key={`f-${i}`} className="flex justify-center items-center">
                                                    <InputCell 
                                                        val={val} idx={i} prefix="f"
                                                        onChange={(v, idx)=>updateArr(v, idx, final, setFinal)}
                                                        correctVal={fDigits[i]}
                                                        disabled={step !== 4}
                                                    />
                                                </div>
                                            ))}
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Actions Panel - Fixed at bottom for mobile */}
                    <div className="w-full bg-white p-3 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30 sm:relative sm:shadow-none sm:bg-transparent sm:max-w-md sm:mb-4">
                        {step === 1 && (
                            <button onClick={checkRow1} className="w-full bg-blue-600 text-white font-bold py-3 sm:py-4 rounded-xl shadow-md text-lg active:scale-95 transition-transform">
                                Check Row 1
                            </button>
                        )}
                        {step === 2 && (
                            <button onClick={checkZero} className="w-full bg-yellow-500 text-white font-bold py-3 sm:py-4 rounded-xl shadow-md text-lg animate-pulse active:scale-95">
                                Place Zero 0Ô∏è‚É£
                            </button>
                        )}
                        {step === 3 && (
                            <button onClick={checkRow2} className="w-full bg-blue-600 text-white font-bold py-3 sm:py-4 rounded-xl shadow-md text-lg active:scale-95 transition-transform">
                                Check Row 2
                            </button>
                        )}
                        {step === 4 && (
                            <button onClick={checkFinal} className="w-full bg-purple-600 text-white font-bold py-3 sm:py-4 rounded-xl shadow-md text-lg active:scale-95 transition-transform">
                                Check Final
                            </button>
                        )}
                        {step === 5 && (
                            <button onClick={handleNext} className="w-full bg-green-600 text-white font-bold py-3 sm:py-4 rounded-xl shadow-md text-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                                Next ‚û°Ô∏è
                            </button>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
